#!/usr/bin/env bash

shopt -s nullglob globstar
passmenu_path="$(readlink -f $0)"
passmenu_fifo="/tmp/passmenu_fifo"

function passmenu_window() {
    prefix=${PASSWORD_STORE_DIR-~/.password-store}
    password_files=( "$prefix"/**/*.gpg )
    password_files=( "${password_files[@]#"$prefix"/}" )
    password_files=( "${password_files[@]%.gpg}" )

    #notify-send "Querying name"
    name="$(printf '%s\n' ${password_files[@]} | sk)"

    #notify-send "Writeback ${name}"
    echo "${name}" > "${passmenu_fifo}"
}

function passmenu_backend() {
    export PASSMENU_BEHAVE_AS_WINDOW=1;
    alacritty -d 80 20 -t passmenu --class passmenu -e "${passmenu_path}"

    #notify-send "Reading name"
    name="$(cat /tmp/passmenu_fifo)"
    rm -f /tmp/passmenu_fifo
    if [ "${name}" == "" ]; then
        exit
    fi
    #notify-send "Copying password"

    gopass show --password "${name}" | wl-copy
    notify-send "âœ” Copied ${name} to clipboard."
}

if [[ -v PASSMENU_BEHAVE_AS_WINDOW ]]; then
    #notify-send "Spawning window"
    passmenu_window
else
    #notify-send "Spawning backend"
    passmenu_backend
fi

