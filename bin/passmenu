#!/usr/bin/env bash

shopt -s nullglob globstar
passmenu_path="$(readlink -f $0)"

function passmenu_window() {
    prefix=${PASSWORD_STORE_DIR-~/.password-store}
    password_files=( "$prefix"/**/*.gpg )
    password_files=( "${password_files[@]#"$prefix"/}" )
    password_files=( "${password_files[@]%.gpg}" )

    name="$(printf '%s\n' ${password_files[@]} | sk)"

    echo "${name}" > /tmp/passmenu_fifo
}

function passmenu_backend() {
    export PASSMENU_BEHAVE_AS_WINDOW=1;
    alacritty -d 80 20 -t passmenu --class passmenu -e "${passmenu_path}"

    name="$(cat /tmp/passmenu_fifo)"
    rm -f /tmp/passmenu_fifo
    if [ "${name}" == "" ]; then
        exit
    fi

    gopass "${name}" | wl-copy
    notify-send "âœ” Copied ${name} to clipboard."
}

if (($PASSMENU_BEHAVE_AS_WINDOW == 1)); then
    passmenu_window
else
    passmenu_backend
fi

